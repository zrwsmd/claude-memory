<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Claude Memory - History Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui;background:#f5f7fa;color:#2d3748}#root{height:100vh}.container{display:flex;height:100%}.sidebar{width:380px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column}.header{padding:20px;border-bottom:1px solid #e2e8f0}.header h1{font-size:22px;margin-bottom:4px}.header .subtitle{font-size:13px;color:#718096;margin-bottom:16px}.search{width:100%;padding:10px;margin-bottom:12px;border:1px solid #cbd5e0;border-radius:8px;font-size:14px}.stats{font-size:12px;color:#718096;margin-top:12px}.list{flex:1;overflow-y:auto}.item{padding:14px 20px;border-bottom:1px solid #e2e8f0;cursor:pointer;transition:background .2s}.item:hover{background:#f7fafc}.item.active{background:#ebf8ff;border-left:4px solid #4299e1}.item-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:6px}.item-title{font-weight:600;font-size:14px;flex:1;margin-right:8px}.item-project{font-size:11px;color:#fff;background:#4299e1;padding:2px 8px;border-radius:12px;white-space:nowrap}.item-preview{font-size:13px;color:#718096;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.item-meta{font-size:11px;color:#a0aec0}.main{flex:1;display:flex;flex-direction:column;overflow:hidden}.content-header{padding:20px;background:#fff;border-bottom:1px solid #e2e8f0}.content-title{font-size:24px;font-weight:700;margin-bottom:8px}.content-meta{font-size:13px;color:#718096}.messages{flex:1;overflow-y:auto;padding:24px}.message{margin-bottom:20px;padding:16px;border-radius:8px}.message.user{background:#ebf8ff;border-left:4px solid #4299e1}.message.assistant{background:#fff;border:1px solid #e2e8f0}.message-role{font-size:12px;font-weight:600;text-transform:uppercase;color:#4299e1;margin-bottom:8px}.message.assistant .message-role{color:#48bb78}.message-content{white-space:pre-wrap;word-wrap:break-word;font-size:14px;line-height:1.6}.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#a0aec0}.empty-icon{font-size:64px;margin-bottom:16px}.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#718096}</style>
</head><body><div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef}=React;const API=window.location.origin;

function App(){
  const [conversations,setConversations]=useState([]);
  const [projects,setProjects]=useState([]);
  const [selectedProject,setSelectedProject]=useState('all');
  const [selected,setSelected]=useState(null);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState('');
  const [filtered,setFiltered]=useState([]);
  const wsRef=useRef(null);

  useEffect(()=>{loadProjects();loadConversations();connectWs()},[]);
  
  useEffect(()=>{
    if(selectedProject==='all'){
      loadConversations();
    }else{
      loadConversationsByProject(selectedProject);
    }
  },[selectedProject]);

  useEffect(()=>{
    if(search.trim()){
      searchConversations(search);
    }else{
      setFiltered(conversations);
    }
  },[search, conversations]);

  const connectWs=()=>{
    const protocol=window.location.protocol==='https:'?'wss:':'ws:';
    const ws=new WebSocket(`${protocol}//${window.location.host}`);
    ws.onmessage=(e)=>{
      const msg=JSON.parse(e.data);
      if(msg.type==='conversations_updated'){
        loadProjects();
        if(selectedProject==='all'){
          loadConversations();
        }else{
          loadConversationsByProject(selectedProject);
        }
      }
    };
    wsRef.current=ws;
  };

  const loadProjects=async()=>{
    try{
      const r=await fetch(`${API}/api/projects`);
      const d=await r.json();
      setProjects(d);
    }catch(e){
      console.error(e);
    }
  };

  const loadConversations=async()=>{
    setLoading(true);
    try{
      const r=await fetch(`${API}/api/conversations`);
      const d=await r.json();
      setConversations(d);
      setFiltered(d);
    }catch(e){
      console.error(e);
    }finally{
      setLoading(false);
    }
  };

  const loadConversationsByProject=async(projectPath)=>{
    setLoading(true);
    try{
      const r=await fetch(`${API}/api/conversations/${encodeURIComponent(projectPath)}`);
      const d=await r.json();
      setConversations(d);
      setFiltered(d);
    }catch(e){
      console.error(e);
    }finally{
      setLoading(false);
    }
  };

  const searchConversations=async(query)=>{
    if(!query.trim()){
      setFiltered(conversations);
      return;
    }
    try{
      const params=new URLSearchParams({query});
      if(selectedProject!=='all'){
        params.append('projectPath',selectedProject);
      }
      const r=await fetch(`${API}/api/search?${params}`);
      const d=await r.json();
      setFiltered(d);
    }catch(e){
      console.error(e);
      const lowerQuery=query.toLowerCase();
      setFiltered(conversations.filter(c=>
        c.firstMessage.toLowerCase().includes(lowerQuery)||
        c.projectName.toLowerCase().includes(lowerQuery)||
        c.messages.some(m=>extractText(m.content).toLowerCase().includes(lowerQuery))
      ));
    }
  };

  const loadConversation=async(conv)=>{
    try{
      const r=await fetch(`${API}/api/conversations/${encodeURIComponent(conv.projectPath)}/${conv.id}`);
      const d=await r.json();
      setSelected(d);
    }catch(e){
      console.error(e);
    }
  };

  const extractText=(content)=>{
    if(typeof content==='string')return content;
    if(Array.isArray(content)){
      return content.map(i=>{
        if(i.type==='text')return i.text||'';
        if(i.type==='tool_use')return `[Tool: ${i.name}]`;
        if(i.type==='tool_result')return '[Tool Result]';
        return '';
      }).join(' ');
    }
    return '';
  };

  const formatDate=(ts)=>new Date(ts).toLocaleString();

  const renderHighlight = (text, query) => {
    if (!query.trim()) {
      return text;
    }
    const parts = text.split(new RegExp(`(${query})`, 'gi'));
    return (
      <>{parts.map((part, i) =>
          part.toLowerCase() === query.toLowerCase()
            ? <strong key={i} style={{color: '#dd6b20', backgroundColor: '#feebc8'}}>{part}</strong>
            : part
        )}</>
    );
  };

  return <div className="container">
    <div className="sidebar">
      <div className="header">
        <h1>ğŸ§  Claude Memory</h1>
        <div className="subtitle">Claude Code History Viewer</div>

        <select
          value={selectedProject}
          onChange={e=>setSelectedProject(e.target.value)}
          style={{width:'100%',padding:'10px',marginBottom:'12px',border:'1px solid #cbd5e0',borderRadius:'8px',fontSize:'14px',background:'#fff',cursor:'pointer'}}
        >
          <option value="all">ğŸ“ All Projects ({projects.reduce((sum, p) => sum + p.conversationCount, 0)})</option>
          {projects.map(p=><option key={p.path} value={p.path}>ğŸ“ {p.name} ({p.conversationCount})</option>)}
        </select>

        <input className="search" placeholder="Search conversations..." value={search} onChange={e=>setSearch(e.target.value)}/>
        {!loading&&<div className="stats">ğŸ’¬ {filtered.length} conversation{filtered.length===1?'':'s'} {search?'found':'shown'}</div>}
      </div>
      <div className="list">
        {loading?<div className="loading">Loading conversations...</div>:
        filtered.length===0?<div style={{padding:20,textAlign:'center',color:'#a0aec0'}}>
          {search?'No matches found':'No conversations found'}
        </div>:
        filtered.map(c=><div key={`${c.projectPath}-${c.id}`} className={`item ${selected?.id===c.id?'active':''}`} onClick={()=>loadConversation(c)}>
          <div className="item-header">
            <div className="item-title">{
              search.trim() && c.searchSnippet
              ? renderHighlight(c.searchSnippet, search)
              : c.firstMessage.length > 80 ? `${c.firstMessage.substring(0, 80)}...` : c.firstMessage
            }</div>
            {selectedProject==='all'&&<div className="item-project">{c.projectName}</div>}
          </div>
          <div className="item-meta">ğŸ’¬ {c.messageCount} messages Â· ğŸ“… {formatDate(c.lastTimestamp)}</div>
        </div>)}
      </div>
    </div>
    <div className="main">
      {selected?<>
        <div className="content-header">
          <div className="content-title">{selected.firstMessage.substring(0,100)}</div>
          <div className="content-meta">
            ğŸ“ {selected.projectName} Â· ğŸ’¬ {selected.messageCount} messages Â· ğŸ“… {formatDate(selected.lastTimestamp)}
          </div>
        </div>
        <div className="messages">
          {selected.messages.map((m,i)=><div key={i} className={`message ${m.role}`}>
            <div className="message-role">{m.role}</div>
            <div className="message-content">{extractText(m.content)}</div>
          </div>)}
        </div>
      </>:<div className="empty">
        <div className="empty-icon">ğŸ’¬</div>
        <h3>No Conversation Selected</h3>
        <p>Select a conversation from the sidebar to view its history</p>
      </div>}
    </div>
  </div>;
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script></body></html>